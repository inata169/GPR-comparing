RTDOSE ガンマ解析 実行手順（2D/3D・三軸シフト最適化対応）

1) 前提条件
- Python 3.9 以上を推奨。
- 実行場所はリポジトリのルート（このファイルと同じ階層）。
- 比較用RTDOSEが存在すること：
  - PHITS_Iris_10_rtdose.dcm
  - RTD.deposit-3D-Lung16Beams-1.5-10-8.dcm

2) 依存ライブラリのインストール
PowerShell 例：
  pip install pydicom numpy scipy matplotlib pymedphys

3) 出力先フォルダの作成
PowerShell 例：
  New-Item -ItemType Directory -Force -Path "phits-linac-validation/output/rtgamma" | Out-Null

4) 3D ガンマ解析（推奨）
最適シフト探索・要約レポート・3D配列保存をまとめて実行：
  python -m rtgamma.main --ref "PHITS_Iris_10_rtdose.dcm" --eval "RTD.deposit-3D-Lung16Beams-1.5-10-8.dcm" --mode 3d --report "phits-linac-validation/output/rtgamma/lung3d_report" --save-gamma-map "phits-linac-validation/output/rtgamma/gamma3d.npz" --save-dose-diff "phits-linac-validation/output/rtgamma/dose_diff3d.npz"

5) 2D ガンマ解析（任意の断面）
axial（横断）スライス index=0 の例（0 起点）：
  python -m rtgamma.main --ref "PHITS_Iris_10_rtdose.dcm" --eval "RTD.deposit-3D-Lung16Beams-1.5-10-8.dcm" --mode 2d --plane axial --plane-index 0 --save-gamma-map "phits-linac-validation/output/rtgamma/gamma_axial.png" --save-dose-diff "phits-linac-validation/output/rtgamma/diff_axial.png" --report "phits-linac-validation/output/rtgamma/lung2d_axial"

6) 主なオプション（抜粋）
- 既定基準：DD=3.0%, DTA=2.0 mm, Cutoff=10%
  - 線量差（%）：  --dd 3.0
  - 許容距離（mm）： --dta 2.0
  - カットオフ（%）： --cutoff 10.0
- 正規化： --norm {global_max,max_ref,none}（既定：global_max）
- ガンマ種別： --gamma-type {global,local}（既定：global）
- シフト探索（3D-CRT/IMRT/VMAT向け）：
  - 既定（±3mm, 1mm刻み）： --shift-range "x:-3:3:1,y:-3:3:1,z:-3:3:1"
  - 広め（3D-CRT例、±5mm）： --shift-range "x:-5:5:1,y:-5:5:1,z:-5:5:1"
- 補間法： --interp {linear,bspline,nearest}（既定：linear）

7) 生成物の確認ポイント
- 3D：
  - phits-linac-validation/output/rtgamma/gamma3d.npz（ガンマ3D配列）
  - phits-linac-validation/output/rtgamma/dose_diff3d.npz（%差分3D配列）
- 2D：
  - phits-linac-validation/output/rtgamma/gamma_axial.png（2Dガンマ画像・例）
  - phits-linac-validation/output/rtgamma/diff_axial.png（2D差分画像・例）
- 要約：
  - phits-linac-validation/output/rtgamma/lung3d_report.csv / .json / .md
  - （探索ログ）phits-linac-validation/output/rtgamma/lung3d_report_search_log.json
  - 主な指標： pass_rate_percent, best_shift_mm, gamma_mean / median / max

8) トラブルシューティング
- 「ModuleNotFoundError: pymedphys」：
  pip install pymedphys
- 「DICOM 読み込みエラー」：対象が RTDOSE（Modality=RTDOSE）かを確認。DoseGridScaling / ImagePositionPatient / ImageOrientationPatient / PixelSpacing / GridFrameOffsetVector が入っているか確認。
- メモリ不足：3D 解析の前に 2D で動作確認し、必要に応じてシフト探索範囲を狭める。

9) 備考
- 実行はリポジトリのルートで行ってください：
  python -m rtgamma.main ...
- ROI/マスク（RTSTRUCT）は未対応（次回対応予定）。

