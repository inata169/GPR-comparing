# Progress Log — 2025-10-16

This note records the key changes, where things live, and next steps so we can quickly resume work later.

## What We Shipped

- Header Compare + RTPLAN
  - `scripts/compare_rtdose_headers.py` now supports `--plan-a/--plan-b`.
  - New `load_rtplan()` in `rtgamma/io_dicom.py` extracts isocenter/SAD/SSD; MD shows `plan_isocenter_delta_*`.
  - Headers summary generator: `scripts/generate_headers_summary.py` → `phits-linac-validation/output/rtgamma/headers_summary.md`.
  - Verified Test01–05 pairs; Test05 (CCC vs MC) is geometry-aligned.

- Optimization & Performance
  - 2‑stage search with 2D prescan + early stop in `rtgamma/optimize.py`.
  - CLI flags exposed: `--fine-range-mm`, `--fine-step-mm`, `--early-stop-*`, `--prescan-2d`.
  - 2D fast path (no shift): compute only the selected slice → major speed‑up.
  - Numba cache enabled; `--threads` respected to set Numba threads.
  - Clinical presets via `--profile {clinical_abs|clinical_rel|clinical_2x2|clinical_3x3}` (all shift‑off).

- GUI (Windows Forms)
  - Launcher: `run_gui.bat` → `scripts/run_gui.ps1`.
  - Features: file pickers (Ref/Eval), output folder, action (Header/3D/2D), clinical preset, plane (2D), threads, Optimize shift checkbox (default OFF), live log, status, elapsed timer, progress bar, auto‑open summary, auto save log, Save Settings.
  - Config: `config/gui_defaults.json` (profile/action/threads/output_dir/open_on_finish/save_log …).
  - Reliability: python `-u` (+ PYTHONUNBUFFERED), working directory set, .NET process events bound to UI (no freeze), PS 5.1 safe (no ternary/inline if, ASCII labels).

- Presets & Docs
  - Preset runner: `scripts/run_presets_test05.ps1` (header → 3D abs → 3D opt → 2D 3‑planes → summary).
  - `command.txt` refreshed with Test05 commands.
  - README updated with GUI Quick Start, tips, config, troubleshooting.

- Tests (pytest)
  - Added lightweight tests under `tests/` and `requirements-dev.txt`:
    - `test_headers_script.py`, `test_cli_2d_axial.py`, `test_io_monotonic.py`, `test_gamma_3d_quick.py`.

- Fixes
  - Removed stray post‑main code (NameError after completion).
  - PowerShell 5.1 compatibility (no `?:`, no inline `If(...)` expression).
  - Log streaming to GUI (unbuffered + events); minor UI overlaps fixed.

## Where Things Are

- GUI: `run_gui.bat`, `scripts/run_gui.ps1`, config at `config/gui_defaults.json`.
- Presets: `scripts/run_presets_test05.ps1`, commands in `command.txt`.
- Header tools: `scripts/compare_rtdose_headers.py`, `scripts/generate_headers_summary.py`.
- Core: `rtgamma/` (io_dicom, main, optimize, gamma, resample, report, viz).
- Outputs: `phits-linac-validation/output/rtgamma/` (images, MD/JSON/CSV, logs, summaries).

## Known Good Runs

- Test05 2D axial (clinical_rel, shift OFF, threads=8): pass rate ≈ 96.873%; images + MD saved (fast path OK).
- Test05 3D (shift OFF) also completes successfully.

## Next Steps (Options)

- GUI UX
  - Add ETA estimate and Cancel button.
  - Log level selector (INFO/DEBUG) and optional rtgamma.log tailing.
  - One‑click ZIP of outputs for sharing.
  - Optional Japanese labels for PowerShell 7 + UTF‑8(BOM) environment.

- Analysis Features
  - ROI/RTSTRUCT masking for ROI‑limited GPR.
  - Local gamma option surfaced in CLI/GUI + reports.

- Automation
  - GitHub Actions CI to run pytest on Windows/Python 3.12.
  - Bash presets (run_presets_test05.sh) for cross‑platform use.

## Notes

- Use clinical presets by default (shift OFF); turn ON Optimize shift only when necessary.
- For speed: set Threads to CPU cores (e.g., 8), warm up with a 2D run before 3D.
- 2D with shift OFF uses the fast path (slice‑only) by design.
