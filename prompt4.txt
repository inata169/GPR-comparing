
# AIエンジニアへの依頼プロンプト：DICOM RTDOSEガンマ解析ツールのデバッグ

## 1. 目的

2つのDICOM RTDOSEファイル（同一条件で線量計算アルゴリズムのみが異なるCCCとMC）の3Dガンマ解析を行ってください。
これらのファイルは、臨床導入前のコミッショニングにおいて「両者にほとんど差はない」と結論付けられた「ゴールドスタンダード」のデータです。したがって、ガンマパス率（3%/2mm）は100%に限りなく近い値になることが期待されます。

## 2.根本的な問題

添付のPython製ガンマ解析ツール `rtgamma` を使用して解析すると、期待に反してパス率が1%未満という極めて低い値になり、かつ-3mm程度の大きな最適空間シフトが検出されてしまいます。
このツールが、ゴールドスタンダードであるべきデータ間の「存在しないはずの差異」を検出してしまう根本原因を特定し、修正してください。

## 3. ファイル情報

- **基準(Ref)ファイル:** `dicom/RTDOSE_2.16.840.1.114337.1.2604.1760077605.1.dcm` (CCCで計算)
- **比較(Eval)ファイル:** `dicom/RTDOSE_2.16.840.1.114337.1.2604.1760079109.1.dcm` (MCで計算)

### DICOMヘッダーの比較サマリ

- **異なる点:**
    - `Rows`, `Columns`: グリッドの寸法が異なる。
    - `ImagePositionPatient`: 座標の原点、特にX軸が-114mm異なる。
    - `DoseGridScaling`: 線量変換係数が異なる。
- **同一である点:**
    - `ImageOrientationPatient`: `[1, 0, 0, 0, 1, 0]` であり、**座標の回転はない**。
    - `PixelSpacing`: `[2, 2]` (2mm) で同一。
    - `GridFrameOffsetVector`: Z軸のジオメトリは完全に同一。

## 4. これまでのデバッグ経緯と結果

これまでに、以下の仮説検証とコード修正を行いましたが、いずれも問題解決には至りませんでした。

1.  **ツールの健全性:** 自己比較（同じファイル同士を比較）ではパス率100%を達成。ガンマ計算のコア自体は正常と思われます。
2.  **`PixelSpacing`の不一致仮説:** 当初、ユーザーからグリッドサイズは3mmと聞いていましたが、DICOMタグの2mmが正しいと後に確認されました。この仮説は誤りでした。
3.  **自動原点補正の不具合仮説:** `ImagePositionPatient`の差(-114mm)が自動補正されていないと疑い、手動で+114mmのシフトを試みましたが、結果はさらに悪化しました。このことから、**ツールは自動で原点補正を正しく行っている**可能性が高いと結論付けました。
4.  **`optimize.py`のバグ修正:** 手動シフトを試みる過程で、`--shift-range`引数で指定した範囲の一部しかテストしないというバグを発見し、これを修正しました。（**添付するコードはこの修正が適用済みです**）
5.  **強制線量正規化の無効化:** `main.py`内で、比較前に線量の最大値を強制的に一致させる処理を発見しました。これは絶対線量比較の前提を覆すため、この処理をコメントアウトしました。（**添付するコードはこの修正も適用済みです**）

## 5. あなたへの具体的なタスク

上記の経緯を踏まえ、添付の `rtgamma` のソースコード（特に `io_dicom.py`, `resample.py`, `main.py`）を精査してください。

問題の根本原因は、我々がまだ見落としている、より深く、より微妙な幾何学的ロジックの不具合にあると考えられます。

- **タスク1:** 2つのファイル間に「存在しないはずの差異」を生み出している根本原因を特定してください。
- **タスク2:** 特定した原因を解決するためのコード修正を提案・実行してください。
- **最終目標:** 修正後のツールで2つのファイルを比較し、最適シフトが(0,0,0)に限りなく近く、かつガンマパス率が100%に限りなく近い結果を得ることです。
